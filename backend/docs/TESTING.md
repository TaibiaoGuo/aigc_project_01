# 测试文档

## 测试概述

本项目包含三种类型的测试：
1. 单元测试
2. 集成测试
3. 性能测试

## 测试环境设置

### 1. 安装测试依赖

```bash
pip install -r requirements-test.txt
```

### 2. 配置测试环境

创建 `tests/.env.test` 文件：

```env
ENVIRONMENT=test
COMFYUI_URL=http://localhost:8188
MAX_WORKERS=2
SESSION_TIMEOUT=3600
CLEANUP_INTERVAL=600
```

## 运行测试

### 1. 运行所有测试

```bash
pytest
```

### 2. 运行特定类型的测试

```bash
# 运行单元测试
pytest tests/unit/

# 运行集成测试
pytest tests/integration/

# 运行性能测试
pytest tests/performance/
```

### 3. 生成测试报告

```bash
# 生成HTML报告
pytest --cov --cov-report=html

# 生成XML报告
pytest --cov --cov-report=xml
```

## 测试类型说明

### 1. 单元测试

测试单个组件或函数的功能。

#### 配置测试
- 测试默认配置
- 测试环境变量配置
- 测试配置验证

#### 会话管理测试
- 测试会话创建
- 测试会话获取
- 测试会话更新
- 测试会话清理

#### 工具函数测试
- 测试目录创建
- 测试工作流路径获取
- 测试文件处理

### 2. 集成测试

测试多个组件之间的交互。

#### API测试
- 测试健康检查
- 测试上传草图
- 测试获取样式配置
- 测试更新样式配置
- 测试获取会话状态

#### WebSocket测试
- 测试连接建立
- 测试消息发送
- 测试消息接收
- 测试连接关闭

### 3. 性能测试

测试系统在不同负载下的表现。

#### 上传性能测试
- 测试单次上传
- 测试批量上传
- 测试并发上传

#### 内存使用测试
- 测试内存泄漏
- 测试内存峰值
- 测试内存回收

#### 响应时间测试
- 测试平均响应时间
- 测试最大响应时间
- 测试响应时间分布

## 测试覆盖率

### 1. 覆盖率要求

- 单元测试覆盖率 > 80%
- 集成测试覆盖率 > 60%
- 关键功能覆盖率 > 90%

### 2. 查看覆盖率报告

```bash
# 生成HTML报告
pytest --cov --cov-report=html

# 在浏览器中打开报告
open htmlcov/index.html
```

## 测试最佳实践

### 1. 编写测试

- 使用描述性的测试名称
- 每个测试只测试一个功能
- 使用适当的断言
- 清理测试数据

### 2. 测试数据

- 使用测试夹具
- 避免硬编码数据
- 使用随机数据
- 清理测试数据

### 3. 测试维护

- 定期更新测试
- 修复失败的测试
- 添加新的测试用例
- 优化测试性能

## 常见问题

### 1. 测试失败

- 检查测试环境
- 验证测试数据
- 查看错误日志
- 检查依赖版本

### 2. 性能问题

- 优化测试代码
- 减少测试数据量
- 使用并行测试
- 优化测试环境

### 3. 覆盖率问题

- 添加更多测试用例
- 检查未覆盖的代码
- 优化测试结构
- 提高测试质量 